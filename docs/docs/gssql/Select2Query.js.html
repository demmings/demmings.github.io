<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Select2Query.js - gsSQL</title>
    
    <meta name="description" content="Query Google Sheets using standard SQL SELECT syntax." />
    
        <meta name="keywords" content="Google, Sheets, Query, SQL, SELECT" />
        <meta name="keyword" content="Google, Sheets, Query, SQL, SELECT" />
    
    
    
    <meta property="og:title" content="gsSQL Sheets Custom Function"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://demmings.github.io/img/logo.png"/>
    <meta property="og:site_name" content="gsSQL"/>
    <meta property="og:url" content="https://demmings.github.io/"/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://demmings.github.io" target="_blank" class="menu-item" id="website_link" >Project Website</a></h2><h2><a href="https://github.com/demmings/gsSQL" target="_blank" class="menu-item" id="website_link" >Github Website</a></h2><h3>Classes</h3><ul><li><a href="BindData.html">BindData</a><ul class='methods'><li data-type='method'><a href="BindData.html#add">add</a></li><li data-type='method'><a href="BindData.html#addList">addList</a></li><li data-type='method'><a href="BindData.html#clear">clear</a></li><li data-type='method'><a href="BindData.html#get">get</a></li><li data-type='method'><a href="BindData.html#getBindDataList">getBindDataList</a></li></ul></li><li><a href="CalculatedField.html">CalculatedField</a><ul class='methods'><li data-type='method'><a href="CalculatedField.html#createAssignmentStatments">createAssignmentStatments</a></li><li data-type='method'><a href="CalculatedField.html#evaluateCalculatedField">evaluateCalculatedField</a></li><li data-type='method'><a href="CalculatedField.html#getData">getData</a></li><li data-type='method'><a href="CalculatedField.html#sqlServerCalcFields">sqlServerCalcFields</a></li><li data-type='method'><a href="CalculatedField.html#sqlServerFunctions">sqlServerFunctions</a></li></ul></li><li><a href="CondLexer.html">CondLexer</a><ul class='methods'><li data-type='method'><a href="CondLexer.html#isFinishedWord">isFinishedWord</a></li><li data-type='method'><a href="CondLexer.html#isStartOrEndOfString">isStartOrEndOfString</a></li></ul></li><li><a href="CondParser.html">CondParser</a><ul class='methods'><li data-type='method'><a href="CondParser.html#parseBaseExpression">parseBaseExpression</a></li><li data-type='method'><a href="CondParser.html#parseGroupExpression">parseGroupExpression</a></li><li data-type='method'><a href="CondParser.html#parseSelectExistsSubQuery">parseSelectExistsSubQuery</a></li><li data-type='method'><a href="CondParser.html#parseSelectIn">parseSelectIn</a></li><li data-type='method'><a href="CondParser.html#parseWordExpression">parseWordExpression</a></li></ul></li><li><a href="ConglomerateRecord.html">ConglomerateRecord</a><ul class='methods'><li data-type='method'><a href="ConglomerateRecord.html#squish">squish</a></li><li data-type='method'><a href="ConglomerateRecord.html#.aggregateColumn">aggregateColumn</a></li><li data-type='method'><a href="ConglomerateRecord.html#.maxCase">maxCase</a></li><li data-type='method'><a href="ConglomerateRecord.html#.minCase">minCase</a></li></ul></li><li><a href="CorrelatedSubQuery.html">CorrelatedSubQuery</a><ul class='methods'><li data-type='method'><a href="CorrelatedSubQuery.html#replaceOuterFieldValueInCorrelatedWhere">replaceOuterFieldValueInCorrelatedWhere</a></li><li data-type='method'><a href="CorrelatedSubQuery.html#select">select</a></li><li data-type='method'><a href="CorrelatedSubQuery.html#traverseWhere">traverseWhere</a></li></ul></li><li><a href="DerivedTable.html">DerivedTable</a><ul class='methods'><li data-type='method'><a href="DerivedTable.html#createTable">createTable</a></li><li data-type='method'><a href="DerivedTable.html#getTableData">getTableData</a></li><li data-type='method'><a href="DerivedTable.html#isDerivedTable">isDerivedTable</a></li><li data-type='method'><a href="DerivedTable.html#setIsOuterJoin">setIsOuterJoin</a></li><li data-type='method'><a href="DerivedTable.html#setLeftField">setLeftField</a></li><li data-type='method'><a href="DerivedTable.html#setLeftRecords">setLeftRecords</a></li><li data-type='method'><a href="DerivedTable.html#setRightField">setRightField</a></li><li data-type='method'><a href="DerivedTable.html#.getCombinedColumnTitles">getCombinedColumnTitles</a></li></ul></li><li><a href="JoinTables.html">JoinTables</a><ul class='methods'><li data-type='method'><a href="JoinTables.html#getJoinedTableInfo">getJoinedTableInfo</a></li><li data-type='method'><a href="JoinTables.html#isDerivedTable">isDerivedTable</a></li><li data-type='method'><a href="JoinTables.html#joinCondition">joinCondition</a></li><li data-type='method'><a href="JoinTables.html#joinNextTable">joinNextTable</a></li><li data-type='method'><a href="JoinTables.html#load">load</a></li><li data-type='method'><a href="JoinTables.html#resolveCondition">resolveCondition</a></li><li data-type='method'><a href="JoinTables.html#setBindVariables">setBindVariables</a></li><li data-type='method'><a href="JoinTables.html#setPrimaryTableInfo">setPrimaryTableInfo</a></li><li data-type='method'><a href="JoinTables.html#setTableFields">setTableFields</a></li><li data-type='method'><a href="JoinTables.html#setTableInfo">setTableInfo</a></li><li data-type='method'><a href="JoinTables.html#.andJoinIds">andJoinIds</a></li><li data-type='method'><a href="JoinTables.html#.joinTables">joinTables</a></li><li data-type='method'><a href="JoinTables.html#.orJoinIds">orJoinIds</a></li></ul></li><li><a href="PropertyData.html">PropertyData</a><ul class='methods'><li data-type='method'><a href="PropertyData.html#.getData">getData</a></li><li data-type='method'><a href="PropertyData.html#.isExpired">isExpired</a></li></ul></li><li><a href="QueryJoin.html">QueryJoin</a><ul class='methods'><li data-type='method'><a href="QueryJoin.html#getKeyRangeString">getKeyRangeString</a></li><li data-type='method'><a href="QueryJoin.html#join">join</a></li><li data-type='method'><a href="QueryJoin.html#joinCondition">joinCondition</a></li><li data-type='method'><a href="QueryJoin.html#leftSelectFields">leftSelectFields</a></li><li data-type='method'><a href="QueryJoin.html#rightSelectFields">rightSelectFields</a></li><li data-type='method'><a href="QueryJoin.html#selectNotInJoin">selectNotInJoin</a></li><li data-type='method'><a href="QueryJoin.html#.createSelectFieldsString">createSelectFieldsString</a></li><li data-type='method'><a href="QueryJoin.html#.createSelectLabelString">createSelectLabelString</a></li><li data-type='method'><a href="QueryJoin.html#.getJoinField">getJoinField</a></li><li data-type='method'><a href="QueryJoin.html#.ifNaResult">ifNaResult</a></li><li data-type='method'><a href="QueryJoin.html#.replaceColumn">replaceColumn</a></li><li data-type='method'><a href="QueryJoin.html#.sortSelectJoinFields">sortSelectJoinFields</a></li></ul></li><li><a href="Schema.html">Schema</a><ul class='methods'><li data-type='method'><a href="Schema.html#getAllExtendedNotationFieldNames">getAllExtendedNotationFieldNames</a></li><li data-type='method'><a href="Schema.html#getAllFieldNames">getAllFieldNames</a></li><li data-type='method'><a href="Schema.html#getAllVirtualFields">getAllVirtualFields</a></li><li data-type='method'><a href="Schema.html#getColumnNameVariants">getColumnNameVariants</a></li><li data-type='method'><a href="Schema.html#getFieldColumn">getFieldColumn</a></li><li data-type='method'><a href="Schema.html#getFieldColumns">getFieldColumns</a></li><li data-type='method'><a href="Schema.html#load">load</a></li><li data-type='method'><a href="Schema.html#setFieldVariantsColumNumber">setFieldVariantsColumNumber</a></li><li data-type='method'><a href="Schema.html#setTable">setTable</a></li><li data-type='method'><a href="Schema.html#setTableAlias">setTableAlias</a></li><li data-type='method'><a href="Schema.html#setTableData">setTableData</a></li><li data-type='method'><a href="Schema.html#setTableName">setTableName</a></li></ul></li><li><a href="ScriptSettings.html">ScriptSettings</a><ul class='methods'><li data-type='method'><a href="ScriptSettings.html#expire">expire</a></li><li data-type='method'><a href="ScriptSettings.html#get">get</a></li><li data-type='method'><a href="ScriptSettings.html#put">put</a></li><li data-type='method'><a href="ScriptSettings.html#putAll">putAll</a></li></ul></li><li><a href="SelectKeywordAnalysis.html">SelectKeywordAnalysis</a><ul class='methods'><li data-type='method'><a href="SelectKeywordAnalysis.html#.extractSelectField">extractSelectField</a></li><li data-type='method'><a href="SelectKeywordAnalysis.html#.getNameAndAlias">getNameAndAlias</a></li><li data-type='method'><a href="SelectKeywordAnalysis.html#.lastIndexOfOutsideLiteral">lastIndexOfOutsideLiteral</a></li><li data-type='method'><a href="SelectKeywordAnalysis.html#.parseForCorrelatedSubQuery">parseForCorrelatedSubQuery</a></li><li data-type='method'><a href="SelectKeywordAnalysis.html#.protect_split">protect_split</a></li></ul></li><li><a href="SelectTables.html">SelectTables</a><ul class='methods'><li data-type='method'><a href="SelectTables.html#createGroupByKey">createGroupByKey</a></li><li data-type='method'><a href="SelectTables.html#getColumnTitles">getColumnTitles</a></li><li data-type='method'><a href="SelectTables.html#getRecordIDs">getRecordIDs</a></li><li data-type='method'><a href="SelectTables.html#getViewData">getViewData</a></li><li data-type='method'><a href="SelectTables.html#groupBy">groupBy</a></li><li data-type='method'><a href="SelectTables.html#groupByFields">groupByFields</a></li><li data-type='method'><a href="SelectTables.html#having">having</a></li><li data-type='method'><a href="SelectTables.html#join">join</a></li><li data-type='method'><a href="SelectTables.html#orderBy">orderBy</a></li><li data-type='method'><a href="SelectTables.html#removeTempColumns">removeTempColumns</a></li><li data-type='method'><a href="SelectTables.html#resolveBindData">resolveBindData</a></li><li data-type='method'><a href="SelectTables.html#resolveCondition">resolveCondition</a></li><li data-type='method'><a href="SelectTables.html#resolveFieldCondition">resolveFieldCondition</a></li><li data-type='method'><a href="SelectTables.html#resolveSubQuery">resolveSubQuery</a></li><li data-type='method'><a href="SelectTables.html#updateSelectedFields">updateSelectedFields</a></li><li data-type='method'><a href="SelectTables.html#whereCondition">whereCondition</a></li><li data-type='method'><a href="SelectTables.html#.dateToMs">dateToMs</a></li><li data-type='method'><a href="SelectTables.html#.existsCondition">existsCondition</a></li><li data-type='method'><a href="SelectTables.html#.extractStringConstant">extractStringConstant</a></li><li data-type='method'><a href="SelectTables.html#.getConditionValue">getConditionValue</a></li><li data-type='method'><a href="SelectTables.html#.getSubQueryTableSet">getSubQueryTableSet</a></li><li data-type='method'><a href="SelectTables.html#.inCondition">inCondition</a></li><li data-type='method'><a href="SelectTables.html#.isCondition">isCondition</a></li><li data-type='method'><a href="SelectTables.html#.isConditionTrue">isConditionTrue</a></li><li data-type='method'><a href="SelectTables.html#.isStringConstant">isStringConstant</a></li><li data-type='method'><a href="SelectTables.html#.likeCondition">likeCondition</a></li><li data-type='method'><a href="SelectTables.html#.parseForFunctions">parseForFunctions</a></li><li data-type='method'><a href="SelectTables.html#.parseForParams">parseForParams</a></li><li data-type='method'><a href="SelectTables.html#.sortByColumnASC">sortByColumnASC</a></li><li data-type='method'><a href="SelectTables.html#.sortByColumnDESC">sortByColumnDESC</a></li><li data-type='method'><a href="SelectTables.html#.toUpperCaseExceptQuoted">toUpperCaseExceptQuoted</a></li></ul></li><li><a href="Sql.html">Sql</a><ul class='methods'><li data-type='method'><a href="Sql.html#addBindNamedRangeParameter">addBindNamedRangeParameter</a></li><li data-type='method'><a href="Sql.html#addBindParameter">addBindParameter</a></li><li data-type='method'><a href="Sql.html#addTableData">addTableData</a></li><li data-type='method'><a href="Sql.html#areColumnTitlesOutput">areColumnTitlesOutput</a></li><li data-type='method'><a href="Sql.html#clearBindParameters">clearBindParameters</a></li><li data-type='method'><a href="Sql.html#copyTableData">copyTableData</a></li><li data-type='method'><a href="Sql.html#enableColumnTitle">enableColumnTitle</a></li><li data-type='method'><a href="Sql.html#execute">execute</a></li><li data-type='method'><a href="Sql.html#getBindData">getBindData</a></li><li data-type='method'><a href="Sql.html#getTables">getTables</a></li><li data-type='method'><a href="Sql.html#getUniquePivotData">getUniquePivotData</a></li><li data-type='method'><a href="Sql.html#pivotField">pivotField</a></li><li data-type='method'><a href="Sql.html#replaceColumnTableNameWith">replaceColumnTableNameWith</a></li><li data-type='method'><a href="Sql.html#select">select</a></li><li data-type='method'><a href="Sql.html#selectFromSubQuery">selectFromSubQuery</a></li><li data-type='method'><a href="Sql.html#selectJoinSubQuery">selectJoinSubQuery</a></li><li data-type='method'><a href="Sql.html#setBindValues">setBindValues</a></li><li data-type='method'><a href="Sql.html#setTables">setTables</a></li><li data-type='method'><a href="Sql.html#unionSets">unionSets</a></li><li data-type='method'><a href="Sql.html#.addCalculatedPivotFieldsToAst">addCalculatedPivotFieldsToAst</a></li><li data-type='method'><a href="Sql.html#.appendUniqueRows">appendUniqueRows</a></li><li data-type='method'><a href="Sql.html#.distinctField">distinctField</a></li><li data-type='method'><a href="Sql.html#.exceptRows">exceptRows</a></li><li data-type='method'><a href="Sql.html#.extractAstTables">extractAstTables</a></li><li data-type='method'><a href="Sql.html#.getReferencedTableNames">getReferencedTableNames</a></li><li data-type='method'><a href="Sql.html#.getReferencedTableNamesFromAst">getReferencedTableNamesFromAst</a></li><li data-type='method'><a href="Sql.html#.getTableAlias">getTableAlias</a></li><li data-type='method'><a href="Sql.html#.getTableAliasFromJoin">getTableAliasFromJoin</a></li><li data-type='method'><a href="Sql.html#.getTableAliasUnion">getTableAliasUnion</a></li><li data-type='method'><a href="Sql.html#.getTableAliasWhereIn">getTableAliasWhereIn</a></li><li data-type='method'><a href="Sql.html#.getTableAliasWhereTerms">getTableAliasWhereTerms</a></li><li data-type='method'><a href="Sql.html#.getTableNamesCorrelatedSelect">getTableNamesCorrelatedSelect</a></li><li data-type='method'><a href="Sql.html#.getTableNamesFrom">getTableNamesFrom</a></li><li data-type='method'><a href="Sql.html#.getTableNamesJoin">getTableNamesJoin</a></li><li data-type='method'><a href="Sql.html#.getTableNamesUnion">getTableNamesUnion</a></li><li data-type='method'><a href="Sql.html#.getTableNamesWhereCondition">getTableNamesWhereCondition</a></li><li data-type='method'><a href="Sql.html#.getTableNamesWhereIn">getTableNamesWhereIn</a></li><li data-type='method'><a href="Sql.html#.getTableNamesWhereTerms">getTableNamesWhereTerms</a></li><li data-type='method'><a href="Sql.html#.intersectRows">intersectRows</a></li><li data-type='method'><a href="Sql.html#.isIterable">isIterable</a></li><li data-type='method'><a href="Sql.html#.loadSchema">loadSchema</a></li><li data-type='method'><a href="Sql.html#.locateAstTableAlias">locateAstTableAlias</a></li><li data-type='method'><a href="Sql.html#.setTableAlias">setTableAlias</a></li></ul></li><li><a href="SqlParse.html">SqlParse</a><ul class='methods'><li data-type='method'><a href="SqlParse.html#.analyzeParts">analyzeParts</a></li><li data-type='method'><a href="SqlParse.html#.generateSqlSeparatorWords">generateSqlSeparatorWords</a></li><li data-type='method'><a href="SqlParse.html#.generateUsedKeywordList">generateUsedKeywordList</a></li><li data-type='method'><a href="SqlParse.html#.getPositionsOfSqlParts">getPositionsOfSqlParts</a></li><li data-type='method'><a href="SqlParse.html#.hideInnerSql">hideInnerSql</a></li><li data-type='method'><a href="SqlParse.html#.makeSqlPartsSplitterRegEx">makeSqlPartsSplitterRegEx</a></li><li data-type='method'><a href="SqlParse.html#.protect">protect</a></li><li data-type='method'><a href="SqlParse.html#.removeDuplicateEntries">removeDuplicateEntries</a></li><li data-type='method'><a href="SqlParse.html#.reorganizeJoins">reorganizeJoins</a></li><li data-type='method'><a href="SqlParse.html#.reorganizeSpecificJoin">reorganizeSpecificJoin</a></li><li data-type='method'><a href="SqlParse.html#.reorganizeUnions">reorganizeUnions</a></li><li data-type='method'><a href="SqlParse.html#.resolveSqlCondition">resolveSqlCondition</a></li><li data-type='method'><a href="SqlParse.html#.sql2ast">sql2ast</a></li><li data-type='method'><a href="SqlParse.html#.sqlCondition2JsCondition">sqlCondition2JsCondition</a></li><li data-type='method'><a href="SqlParse.html#.sqlStatementSplitter">sqlStatementSplitter</a></li><li data-type='method'><a href="SqlParse.html#.unprotect">unprotect</a></li></ul></li><li><a href="SqlServerFunctions.html">SqlServerFunctions</a><ul class='methods'><li data-type='method'><a href="SqlServerFunctions.html#caseEnd">caseEnd</a></li><li data-type='method'><a href="SqlServerFunctions.html#caseStart">caseStart</a></li><li data-type='method'><a href="SqlServerFunctions.html#caseWhen">caseWhen</a></li><li data-type='method'><a href="SqlServerFunctions.html#convertToJs">convertToJs</a></li><li data-type='method'><a href="SqlServerFunctions.html#parseFunctionArgs">parseFunctionArgs</a></li><li data-type='method'><a href="SqlServerFunctions.html#.charIndex">charIndex</a></li><li data-type='method'><a href="SqlServerFunctions.html#.coalesce">coalesce</a></li><li data-type='method'><a href="SqlServerFunctions.html#.concat">concat</a></li><li data-type='method'><a href="SqlServerFunctions.html#.concat_ws">concat_ws</a></li><li data-type='method'><a href="SqlServerFunctions.html#.convert">convert</a></li></ul></li><li><a href="Table.html">Table</a><ul class='methods'><li data-type='method'><a href="Table.html#addColumnLetters">addColumnLetters</a></li><li data-type='method'><a href="Table.html#concat">concat</a></li><li data-type='method'><a href="Table.html#createCalcFieldRecordMap">createCalcFieldRecordMap</a></li><li data-type='method'><a href="Table.html#createKeyFieldRecordMap">createKeyFieldRecordMap</a></li><li data-type='method'><a href="Table.html#getAllExtendedNotationFieldNames">getAllExtendedNotationFieldNames</a></li><li data-type='method'><a href="Table.html#getAllFieldNames">getAllFieldNames</a></li><li data-type='method'><a href="Table.html#getAllVirtualFields">getAllVirtualFields</a></li><li data-type='method'><a href="Table.html#getColumnCount">getColumnCount</a></li><li data-type='method'><a href="Table.html#getFieldColumn">getFieldColumn</a></li><li data-type='method'><a href="Table.html#getFieldColumns">getFieldColumns</a></li><li data-type='method'><a href="Table.html#getRecords">getRecords</a></li><li data-type='method'><a href="Table.html#loadArrayData">loadArrayData</a></li><li data-type='method'><a href="Table.html#loadNamedRangeData">loadNamedRangeData</a></li><li data-type='method'><a href="Table.html#loadSchema">loadSchema</a></li><li data-type='method'><a href="Table.html#numberToSheetColumnLetter">numberToSheetColumnLetter</a></li><li data-type='method'><a href="Table.html#search">search</a></li><li data-type='method'><a href="Table.html#setHasColumnTitle">setHasColumnTitle</a></li><li data-type='method'><a href="Table.html#setTableAlias">setTableAlias</a></li><li data-type='method'><a href="Table.html#.removeEmptyRecordsAtEndOfTable">removeEmptyRecordsAtEndOfTable</a></li></ul></li><li><a href="TableData.html">TableData</a><ul class='methods'><li data-type='method'><a href="TableData.html#.cacheGetArray">cacheGetArray</a></li><li data-type='method'><a href="TableData.html#.cachePutArray">cachePutArray</a></li><li data-type='method'><a href="TableData.html#.cacheStatusName">cacheStatusName</a></li><li data-type='method'><a href="TableData.html#.fixJSONdates">fixJSONdates</a></li><li data-type='method'><a href="TableData.html#.forceLongCacheExpiryCheck">forceLongCacheExpiryCheck</a></li><li data-type='method'><a href="TableData.html#.getValueCached">getValueCached</a></li><li data-type='method'><a href="TableData.html#.getValuesCached">getValuesCached</a></li><li data-type='method'><a href="TableData.html#.isRangeLoading">isRangeLoading</a></li><li data-type='method'><a href="TableData.html#.isTimeToRunLongCacheExpiry">isTimeToRunLongCacheExpiry</a></li><li data-type='method'><a href="TableData.html#.loadTableData">loadTableData</a></li><li data-type='method'><a href="TableData.html#.loadValuesFromRangeOrSheet">loadValuesFromRangeOrSheet</a></li><li data-type='method'><a href="TableData.html#.lockLoadAndCache">lockLoadAndCache</a></li><li data-type='method'><a href="TableData.html#.setLongCacheExpiry">setLongCacheExpiry</a></li><li data-type='method'><a href="TableData.html#.setValueCached">setValueCached</a></li><li data-type='method'><a href="TableData.html#.setValuesCached">setValuesCached</a></li><li data-type='method'><a href="TableData.html#.verifyCachedData">verifyCachedData</a></li><li data-type='method'><a href="TableData.html#.waitForRangeToLoad">waitForRangeToLoad</a></li></ul></li><li><a href="TableField.html">TableField</a><ul class='methods'><li data-type='method'><a href="TableField.html#addAlias">addAlias</a></li><li data-type='method'><a href="TableField.html#getData">getData</a></li><li data-type='method'><a href="TableField.html#setAggregateFunction">setAggregateFunction</a></li><li data-type='method'><a href="TableField.html#setCalculatedFormula">setCalculatedFormula</a></li><li data-type='method'><a href="TableField.html#setColumnName">setColumnName</a></li><li data-type='method'><a href="TableField.html#setColumnTitle">setColumnTitle</a></li><li data-type='method'><a href="TableField.html#setDistinctSetting">setDistinctSetting</a></li><li data-type='method'><a href="TableField.html#setIsPrimaryTable">setIsPrimaryTable</a></li><li data-type='method'><a href="TableField.html#setIsTempField">setIsTempField</a></li><li data-type='method'><a href="TableField.html#setOriginalTable">setOriginalTable</a></li><li data-type='method'><a href="TableField.html#setOriginalTableColumn">setOriginalTableColumn</a></li><li data-type='method'><a href="TableField.html#setSelectColumn">setSelectColumn</a></li><li data-type='method'><a href="TableField.html#setSubQueryAst">setSubQueryAst</a></li><li data-type='method'><a href="TableField.html#setTableInfo">setTableInfo</a></li><li data-type='method'><a href="TableField.html#.getAllExtendedAliasNames">getAllExtendedAliasNames</a></li></ul></li><li><a href="TableFields.html">TableFields</a><ul class='methods'><li data-type='method'><a href="TableFields.html#addReferencedColumnstoSelectFieldList">addReferencedColumnstoSelectFieldList</a></li><li data-type='method'><a href="TableFields.html#addTempMissingSelectedField">addTempMissingSelectedField</a></li><li data-type='method'><a href="TableFields.html#findTableField">findTableField</a></li><li data-type='method'><a href="TableFields.html#getColumnNames">getColumnNames</a></li><li data-type='method'><a href="TableFields.html#getColumnTitles">getColumnTitles</a></li><li data-type='method'><a href="TableFields.html#getConglomerateFieldCount">getConglomerateFieldCount</a></li><li data-type='method'><a href="TableFields.html#getFieldColumn">getFieldColumn</a></li><li data-type='method'><a href="TableFields.html#getFieldInfo">getFieldInfo</a></li><li data-type='method'><a href="TableFields.html#getNextSelectColumnNumber">getNextSelectColumnNumber</a></li><li data-type='method'><a href="TableFields.html#getSelectFieldColumn">getSelectFieldColumn</a></li><li data-type='method'><a href="TableFields.html#getSelectFields">getSelectFields</a></li><li data-type='method'><a href="TableFields.html#getTableInfo">getTableInfo</a></li><li data-type='method'><a href="TableFields.html#getTempSelectedColumnNumbers">getTempSelectedColumnNumbers</a></li><li data-type='method'><a href="TableFields.html#hasField">hasField</a></li><li data-type='method'><a href="TableFields.html#indexTableField">indexTableField</a></li><li data-type='method'><a href="TableFields.html#loadVirtualFields">loadVirtualFields</a></li><li data-type='method'><a href="TableFields.html#parseAstSelectField">parseAstSelectField</a></li><li data-type='method'><a href="TableFields.html#updateDerivedTableVirtualFields">updateDerivedTableVirtualFields</a></li><li data-type='method'><a href="TableFields.html#updateSelectFieldList">updateSelectFieldList</a></li><li data-type='method'><a href="TableFields.html#.getSelectCountModifiers">getSelectCountModifiers</a></li><li data-type='method'><a href="TableFields.html#.sortPrimaryFields">sortPrimaryFields</a></li></ul></li><li><a href="TestedStatements.html">TestedStatements</a><ul class='methods'><li data-type='method'><a href="TestedStatements.html#getTableDefinitionString">getTableDefinitionString</a></li></ul></li><li><a href="VirtualField.html">VirtualField</a></li><li><a href="VirtualFields.html">VirtualFields</a><ul class='methods'><li data-type='method'><a href="VirtualFields.html#add">add</a></li><li data-type='method'><a href="VirtualFields.html#getAllVirtualFields">getAllVirtualFields</a></li><li data-type='method'><a href="VirtualFields.html#.expandWildcardFields">expandWildcardFields</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#SQLselfTest">SQLselfTest</a></li><li><a href="global.html#customMenuGenerateTests">customMenuGenerateTests</a></li><li><a href="global.html#gsSQL">gsSQL</a></li><li><a href="global.html#isEqual">isEqual</a></li><li><a href="global.html#onOpen">onOpen</a></li><li><a href="global.html#sqlTestCases">sqlTestCases</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">Select2Query.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// @author Chris Demmings - https://demmings.github.io/
//  *** DEBUG START ***
//  Remove comments for testing in NODE
import { SqlParse } from './SimpleParser.js';
export { Select2Query };

class Logger {
    static log(msg) {
        console.log(msg);
    }
}
//  *** DEBUG END ***/


class Select2Query {
    /**
     * 
     * @param  {...any} parms 
     * @returns {Select2Query}
     */
    setTables(...parms) {
        this.tables = Select2Query.addTableData(parms);
        return this;
    }

    /**
     * 
     * @param {Map&lt;String,String>} tables 
     * @returns {Select2Query}
     */
    setTableMap(tables) {
        this.tables = tables;
        return this;
    }

    /**
     * 
     * @param {any} selectStatement 
     * @returns {String}
     */
    convert(selectStatement) {
        let queryStatement = "";
        let ast = null;
        let query = "";

        if (typeof selectStatement === 'string') {
            try {
                ast = SqlParse.sql2ast(selectStatement);
            }
            catch (ex) {
                return ex.toString();
            }
        }
        else {
            ast = selectStatement;
        }

        if (typeof ast.JOIN !== 'undefined') {
            const joinQuery = new QueryJoin(this.tables);
            query = joinQuery.join(ast);
        }
        else {
            queryStatement = Select2Query.selectFields(ast);
            queryStatement += this.whereCondition(ast);
            queryStatement += this.groupBy(ast);
            queryStatement += Select2Query.orderBy(ast);

            query = this.formatAsQuery(queryStatement, ast.FROM.table);
        }

        console.log(query);

        return query;
    }

    /**
     * 
     * @param {String} statement 
     * @param {String} tableName 
     * @returns {String}
     */
    formatAsQuery(statement, tableName) {
        const range = this.tables.has(tableName.toUpperCase()) ? this.tables.get(tableName.toUpperCase()) : "";

        return `=QUERY(${range}, "${statement}")`;
    }

    /**
     * 
     * @param {String[]} parms 
     * @returns {Map&lt;String,String>}
     */
    static addTableData(parms) {
        const tables = new Map();

        //  Should be:  TABLE NAME, TABLE RANGE, name, range, name, range,...
        let i = 0;
        while (i + 1 &lt; parms.length) {
            console.log(`Add Table: ${parms[i]}. Items=${parms[i + 1].length}`);
            tables.set(parms[i].trim().toUpperCase(), parms[i + 1]);
            i += 2;
        }

        return tables;
    }

    /**
     * 
     * @param {Object} ast 
     * @returns {String}
     */
    static selectFields(ast) {
        let selectStr = "SELECT ";
        if (typeof ast.SELECT !== 'undefined') {
            for (let i = 0; i &lt; ast.SELECT.length; i++) {
                const fld = ast.SELECT[i];

                let fieldName = fld.name;
                if (fld.name.indexOf(".") !== -1) {
                    const parts = fld.name.split(".");
                    fieldName = parts[1];
                }
                selectStr += fieldName.toUpperCase();

                if (i + 1 &lt; ast.SELECT.length) {
                    selectStr += ", ";
                }
            }
        }

        return selectStr;
    }

    /**
     * Retrieve filtered record ID's.
     * @param {Object} ast - Abstract Syntax Tree
     * @returns {String} - Query WHERE condition.
     */
    whereCondition(ast) {
        let queryWhere = "";

        let conditions = {};
        if (typeof ast.WHERE !== 'undefined') {
            conditions = ast.WHERE;
        }
        else {
            //  Entire table is selected.  
            return queryWhere;
        }

        if (typeof conditions.logic === 'undefined')
            queryWhere = this.resolveCondition("OR", [conditions], "");
        else
            queryWhere = this.resolveCondition(conditions.logic, conditions.terms, "");

        return " WHERE " + queryWhere.trim();
    }

    /**
    * Recursively resolve WHERE condition and then apply AND/OR logic to results.
    * @param {String} logic - logic condition (AND/OR) between terms
    * @param {Object} terms - terms of WHERE condition (value compared to value)
    * @returns {String} - condition of where 
    */
    resolveCondition(logic, terms, queryWhere) {

        for (let i = 0; i &lt; terms.length; i++) {
            const cond = terms[i];

            if (typeof cond.logic === 'undefined') {
                queryWhere += this.whereString(cond);
            }
            else {
                queryWhere = this.resolveCondition(cond.logic, cond.terms, queryWhere);
            }

            if (i + 1 &lt; terms.length) {
                queryWhere += " " + logic;
            }
        }

        return queryWhere;
    }

    /**
     * 
     * @param {Object} cond 
     * @returns {String}
     */
    whereString(cond) {
        let whereStr = "";

        switch (cond.operator) {
            case "NOT IN":
                whereStr = ` NOT ${this.whereValue(cond.left)} ${Select2Query.whereOp("IN")} ${this.whereValue(cond.right)}`;
                break;
            case "IN":
            default:
                whereStr = ` ${this.whereValue(cond.left)} ${Select2Query.whereOp(cond.operator)} ${this.whereValue(cond.right)}`;
                break;
        }

        return whereStr;
    }

    /**
     * 
     * @param {String} operator 
     * @returns {String}
     */
    static whereOp(operator) {
        if (operator.trim().toUpperCase() === 'IN')
            return "MATCHES";

        return operator;
    }

    /**
     * 
     * @param {Object} cond 
     * @returns {String}
     */
    whereValue(cond) {
        if (typeof cond.SELECT === 'undefined') {
            return cond;
        }
        else {
            const sql = new Select2Query().setTableMap(this.tables)

            const preTextJoin = "'\"&amp;TEXTJOIN(\"|\", true, ";
            const postTextJoin = ")&amp;\"'";
            const query = sql.convert(cond).slice(1);       //  Get rid of starting '='.
            return preTextJoin + query + postTextJoin;
        }
    }

    /**
     * 
     * @param {Object} ast 
     * @returns {String}
     */
    static orderBy(ast) {
        let orderBy = "";

        if (typeof ast['ORDER BY'] === 'undefined') {
            return orderBy;
        }

        orderBy = " ORDER BY "
        for (let i = 0; i &lt; ast['ORDER BY'].length; i++) {
            const order = ast['ORDER BY'][i];
            orderBy += order.name + " " + order.order.toUpperCase();

            if (i + 1 &lt; ast['ORDER BY'].length) {
                orderBy += ", ";
            }
        }

        return orderBy;
    }

    /**
     * 
     * @param {Object} ast 
     * @returns {String}
     */
    groupBy(ast) {
        let groupBy = "";

        if (typeof ast['GROUP BY'] === 'undefined') {
            return groupBy;
        }

        groupBy += " GROUP BY ";

        for (let i = 0; i &lt; ast['GROUP BY'].length; i++) {
            let order = ast['GROUP BY'][i];
            groupBy += order.name;

            if (i + 1 &lt; ast['GROUP BY'].length) {
                groupBy += ", ";
            }
        }

        return groupBy;
    }


}

class QueryJoin {
    /**
     * 
     * @param {Map&lt;String,String>} tables 
     */
    constructor(tables) {
        this.tables = tables;
    }

    /**
     * 
     * @param {Object} ast 
     * @returns {String}
     */
    join(ast) {
        let query = "";

        for (const joinAst of ast.JOIN) {
            query += this.joinCondition(ast.FROM.table, ast.SELECT, joinAst, ast);
        }

        return query;
    }

    /**
     * @param {String} leftTable
     * @param {Object} selectFields
     * @param {Object} joinAst 
     * @param {Object} ast
     * @returns {String}
     */
    joinCondition(leftTable, selectFields, joinAst, ast) {
        const LEFT_KEY_RANGE = "$$LEFT_KEY$$";
        const LEFT_SELECT_FIELDS = "$$LEFT_SELECT$$";
        const RIGHT_KEY_RANGE = "$$RIGHT_KEY$$";
        const RIGHT_SELECT_FIELDS = "$$RIGHT_SELECT$$";
        const NO_MATCH_QUERY = "$$NO_MATCH$$";

        let query = "";
        let rightTable = joinAst.table;
        let conditionLeft = joinAst.cond.left;
        let conditionRight = joinAst.cond.right

        if (joinAst.type === 'right') {
            let temp = leftTable;
            leftTable = rightTable;
            rightTable = temp;

            temp = conditionLeft;
            conditionLeft = conditionRight;
            conditionRight = temp;
        }

        const leftKeyRangeValue = this.getKeyRangeString(leftTable, conditionLeft);
        const rightKeyRangeValue = this.getKeyRangeString(rightTable, conditionRight);
        const leftSelectFieldValue = this.leftSelectFields(selectFields, leftTable);
        let rightSelectFieldValue = this.rightSelectFields(selectFields, rightTable);
        const notFoundQuery = this.selectNotInJoin(ast, joinAst, leftTable, rightTable);

        if (leftSelectFieldValue !== '' &amp;&amp; rightSelectFieldValue !== '') {
            rightSelectFieldValue = `&amp;"!"&amp;${rightSelectFieldValue}`;
        }

        const joinFormatString = '={ArrayFormula(Split(Query(Flatten(IF($$LEFT_KEY$$=Split(Textjoin("!",1,$$RIGHT_KEY$$),"!"),$$LEFT_SELECT$$ $$RIGHT_SELECT$$,)),"Where Col1!=\'\'"),"!"))$$NO_MATCH$$}';

        query = joinFormatString.replace(LEFT_KEY_RANGE, leftKeyRangeValue);
        query = query.replace(RIGHT_KEY_RANGE, rightKeyRangeValue);
        query = query.replace(LEFT_SELECT_FIELDS, leftSelectFieldValue);
        query = query.replace(RIGHT_SELECT_FIELDS, rightSelectFieldValue);
        query = query.replace(NO_MATCH_QUERY, notFoundQuery);

        const sql = new Select2Query();
        sql.setTableMap(this.tables);

        return query;
    }

    /**
     * 
     * @param {String} tableName 
     * @param {String} condition 
     * @returns {String}
     */
    getKeyRangeString(tableName, condition) {
        const tableInfo = this.tables.get(tableName.toUpperCase());
        let field = condition;
        if (condition.indexOf(".") !== -1) {
            const parts = condition.split(".");
            field = parts[1];
        }
        let range = tableInfo;
        let rangeTable = "";
        if (range.indexOf("!") !== -1) {
            const parts = range.split("!");
            rangeTable = parts[0] + "!";
            range = parts[1];
        }

        const rangeComponents = range.split(":");
        const startRange = QueryJoin.replaceColumn(rangeComponents[0], field);
        const endRange = QueryJoin.replaceColumn(rangeComponents[1], field);

        return rangeTable + startRange + ":" + endRange;
    }

    /**
     * 
     * @param {String} rowColumn 
     * @param {String} newColumn 
     * @returns {String}
     */
    static replaceColumn(rowColumn, newColumn) {
        const num = rowColumn.replace(/\D/g, '');
        return newColumn + num;
    }

    /**
     * 
     * @param {Object} ast 
     * @param {Object} joinAst 
     * @param {String} leftTable 
     * @param {String} rightTable 
     * @returns {String}
     */
    selectNotInJoin(ast, joinAst, leftTable, rightTable) {
        if (joinAst.type === 'inner') {
            return "";
        }

        leftTable = leftTable.toUpperCase();

        //  Sort fields so that LEFT table are first and RIGHT table are after.
        const sortedFields = QueryJoin.sortSelectJoinFields(ast, leftTable);

        const selectFlds = QueryJoin.createSelectFieldsString(sortedFields);
        const label = QueryJoin.createSelectLabelString(sortedFields);
        const rightFieldName = QueryJoin.getJoinField(joinAst, joinAst.cond.right, joinAst.cond.left);
        const leftFieldName = QueryJoin.getJoinField(joinAst, joinAst.cond.left, joinAst.cond.right);
        const leftRange = this.tables.get(leftTable.toUpperCase());
        const rightRange = this.tables.get(rightTable.toUpperCase());

        const queryStart = `QUERY(${leftRange},`;
        let selectStr = `${queryStart}"select ${selectFlds} where ${rightFieldName} is not null and NOT ${rightFieldName} MATCHES `;

        const matchesQuery = `'"&amp;TEXTJOIN("|", true, QUERY(${rightRange}, "SELECT ${leftFieldName} where ${leftFieldName} is not null"))&amp;`;
        selectStr += matchesQuery;
        selectStr = selectStr + label + '", 0)';

        //  If no records are found, we need to insert an empty record - otherwise we get an array error.
        selectStr = `;IFNA(${selectStr},${QueryJoin.ifNaResult(ast)})`;


        return selectStr;
    }

    /**
     * 
     * @param {Object} joinAst 
     * @param {String} rightSide 
     * @param {String} leftSide 
     * @returns {String}
     */
    static getJoinField(joinAst, rightSide, leftSide) {
        let fieldName = "";
        if (joinAst.type === 'right') {
            fieldName = rightSide;
        }
        else {
            fieldName = leftSide;
        }
        if (fieldName.indexOf(".") !== -1) {
            const parts = fieldName.split(".");
            fieldName = parts[1];
        }

        return fieldName;
    }

    /**
     * @typedef {Object} JoinSelectField
     * @property {String} fieldTable
     * @property {String} fieldName
     * @property {Boolean} isNull
     */

    /**
     * @param {Object} ast 
     * @param {String} leftTable
     * @returns {JoinSelectField[]}
     */
    static sortSelectJoinFields(ast, leftTable) {
        //  Sort fields so that LEFT table are first and RIGHT table are after.
        const leftFields = [];
        const rightFields = [];
        let nullCnt = 1;

        for (const fld of ast.SELECT) {
            let fieldTable = leftTable.toUpperCase();
            let fieldName = fld.name.toUpperCase();
            if (fld.name.indexOf(".") !== -1) {
                const parts = fld.name.split(".");
                fieldTable = parts[0].toUpperCase();
                fieldName = parts[1].toUpperCase();
            }

            const isNull = false;
            const fieldInfo = {
                fieldTable,
                fieldName,
                isNull
            };

            if (fieldTable === leftTable) {
                leftFields.push(fieldInfo);
            }
            else {
                fieldInfo.fieldName = `'null${" ".repeat(nullCnt)}'`;
                fieldInfo.isNull = true;
                nullCnt++;
                rightFields.push(fieldInfo);
            }
        }

        return leftFields.concat(rightFields);
    }

    /**
     * Build a string that will be used in IFNA() when select does not find any records.
     * @param {Object} ast 
     * @returns {String}
     */
    static ifNaResult(ast) {
        let naResult = "";
        for (let i = 0; i &lt; ast.SELECT.length; i++) {
            naResult = (naResult === '') ? "" : `${naResult},`;
            naResult += '""';
        }

        if (naResult !== "") {
            naResult = `{${naResult}}`;
        }

        return naResult;
    }

    /**
     * 
     * @param {JoinSelectField[]} sortedFields 
     * @returns {String}
     */
    static createSelectFieldsString(sortedFields) {
        let selectFlds = "";

        for (const fld of sortedFields) {
            selectFlds = (selectFlds === '' ? '' : `${selectFlds},`) + fld.fieldName;
        }

        return selectFlds;
    }

    /**
    * 
    * @param {JoinSelectField[]} sortedFields 
    * @returns {String}
    */
    static createSelectLabelString(sortedFields) {
        let label = "";

        for (const fld of sortedFields) {
            if (fld.isNull) {
                label = label !== "" ? `${label}, ` : "";
                label += fld.fieldName + " ''";
            }
        }

        if (label !== "") {
            label = `"' label ${label}`;
        }

        return label;
    }

    /**
     * Assembled selected fields string for LEFT.
     * @param {Object} ast 
     * @param {String} leftTable 
     * @returns {String}
     */
    leftSelectFields(ast, leftTable) {
        let leftSelect = "";

        for (const fld of ast) {
            let selectField = "";

            if (fld.name.indexOf(".") === -1) {
                selectField = fld.name;
            }
            else {
                let parts = fld.name.split(".");
                if (parts[0].toUpperCase() === leftTable.toUpperCase()) {
                    selectField = parts[1];
                }
            }

            let rangeTable = "";
            let range = "";
            if (selectField !== "") {
                const tableInfo = this.tables.get(leftTable.toUpperCase());

                if (tableInfo.indexOf("!") !== -1) {
                    const parts = tableInfo.split("!");
                    rangeTable = parts[0] + "!";
                    range = parts[1];
                }

                const rangeComponents = range.split(":");
                const startRange = QueryJoin.replaceColumn(rangeComponents[0], selectField);
                const endRange = QueryJoin.replaceColumn(rangeComponents[1], selectField);

                selectField = rangeTable + startRange + ":" + endRange;

                leftSelect = leftSelect === '' ? '' : `${leftSelect}&amp;"!"&amp; `;

                leftSelect += 'IF(' + selectField + ' &lt;> "",' + selectField + ', " ")';
            }
        }

        return leftSelect;
    }

    /**
     * assemble SELECTED FIELDS string for RIGHT.
     * @param {Object} ast 
     * @param {String} rightTable 
     * @returns {String}
     */
    rightSelectFields(ast, rightTable) {
        let rightSelect = "";

        for (const fld of ast) {
            let selectField = "";

            if (fld.name.indexOf(".") === -1) {
                selectField = fld.name;
            }
            else {
                const parts = fld.name.split(".");
                if (parts[0].toUpperCase() === rightTable.toUpperCase()) {
                    selectField = parts[1];
                }
            }

            let rangeTable = "";
            let range = "";
            if (selectField !== "") {
                const tableInfo = this.tables.get(rightTable.toUpperCase());

                if (tableInfo.indexOf("!") !== -1) {
                    const parts = tableInfo.split("!");
                    rangeTable = parts[0] + "!";
                    range = parts[1];
                }

                const rangeComponents = range.split(":");
                const startRange = QueryJoin.replaceColumn(rangeComponents[0], selectField);
                const endRange = QueryJoin.replaceColumn(rangeComponents[1], selectField);

                selectField = rangeTable + startRange + ":" + endRange;

                rightSelect = rightSelect === '' ? '' : `${rightSelect}&amp;"!"&amp; `;

                rightSelect += 'Split(Textjoin("!",1,IF(' + selectField + '&lt;>"",' + selectField + '," ")),"!")';
            }
        }

        return rightSelect;
    }
}</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.0</a> on Sat Apr 29 2023 13:32:15 GMT-0400 (Eastern Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
